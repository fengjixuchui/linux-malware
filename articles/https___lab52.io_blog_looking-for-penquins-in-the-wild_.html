<!DOCTYPE html>
<html lang="en-GB">
<head >
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Looking for Penquins in the Wild</title>
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="lab52 &raquo; Feed" href="https://lab52.io/blog/feed/" />
<link rel="alternate" type="application/rss+xml" title="lab52 &raquo; Comments Feed" href="https://lab52.io/blog/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="lab52 &raquo; Looking for Penquins in the Wild Comments Feed" href="https://lab52.io/blog/looking-for-penquins-in-the-wild/feed/" />
<link rel="canonical" href="https://lab52.io/blog/looking-for-penquins-in-the-wild/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/lab52.io\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.5.11"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='atomic-blocks-fontawesome-css'  href='https://lab52.io/blog/wp-content/plugins/atomic-blocks/dist/assets/fontawesome/css/all.min.css?ver=1598525594' type='text/css' media='all' />
<link rel='stylesheet' id='genesis-sample-css'  href='https://lab52.io/blog/wp-content/themes/genesis-sample-develop/style.css?ver=2.9.2-dev' type='text/css' media='all' />
<style id='genesis-sample-inline-css' type='text/css'>

		.wp-custom-logo .title-area {
			padding-top: 7px;
		}
		
</style>
<link rel='stylesheet' id='wp-block-library-css'  href='https://lab52.io/blog/wp-includes/css/dist/block-library/style.min.css?ver=5.5.11' type='text/css' media='all' />
<link rel='stylesheet' id='atomic-blocks-style-css-css'  href='https://lab52.io/blog/wp-content/plugins/atomic-blocks/dist/blocks.style.build.css?ver=1598525594' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='https://lab52.io/blog/wp-includes/css/dashicons.min.css?ver=5.5.11' type='text/css' media='all' />
<link rel='stylesheet' id='genesis-sample-gutenberg-css'  href='https://lab52.io/blog/wp-content/themes/genesis-sample-develop/lib/gutenberg/front-end.css?ver=2.9.2-dev' type='text/css' media='all' />
<style id='genesis-sample-gutenberg-inline-css' type='text/css'>
.ab-block-post-grid .ab-post-grid-items h2 a:hover {
	color: #0073e5;
}

.site-container .wp-block-button .wp-block-button__link {
	background-color: #0073e5;
}

.wp-block-button .wp-block-button__link:not(.has-background),
.wp-block-button .wp-block-button__link:not(.has-background):focus,
.wp-block-button .wp-block-button__link:not(.has-background):hover {
	color: #ffffff;
}

.site-container .wp-block-button.is-style-outline .wp-block-button__link {
	color: #0073e5;
}

.site-container .wp-block-button.is-style-outline .wp-block-button__link:focus,
.site-container .wp-block-button.is-style-outline .wp-block-button__link:hover {
	color: #2396ff;
}		.site-container .has-small-font-size {
			font-size: 12px;
		}		.site-container .has-normal-font-size {
			font-size: 18px;
		}		.site-container .has-large-font-size {
			font-size: 20px;
		}		.site-container .has-larger-font-size {
			font-size: 24px;
		}		.site-container .has-theme-primary-color,
		.site-container .wp-block-button .wp-block-button__link.has-theme-primary-color,
		.site-container .wp-block-button.is-style-outline .wp-block-button__link.has-theme-primary-color {
			color: #0073e5;
		}

		.site-container .has-theme-primary-background-color,
		.site-container .wp-block-button .wp-block-button__link.has-theme-primary-background-color,
		.site-container .wp-block-pullquote.is-style-solid-color.has-theme-primary-background-color {
			background-color: #0073e5;
		}		.site-container .has-theme-secondary-color,
		.site-container .wp-block-button .wp-block-button__link.has-theme-secondary-color,
		.site-container .wp-block-button.is-style-outline .wp-block-button__link.has-theme-secondary-color {
			color: #0073e5;
		}

		.site-container .has-theme-secondary-background-color,
		.site-container .wp-block-button .wp-block-button__link.has-theme-secondary-background-color,
		.site-container .wp-block-pullquote.is-style-solid-color.has-theme-secondary-background-color {
			background-color: #0073e5;
		}
</style>
<link rel='stylesheet' id='simple-social-icons-font-css'  href='https://lab52.io/blog/wp-content/plugins/simple-social-icons/css/style.css?ver=3.0.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpgdprc.css-css'  href='https://lab52.io/blog/wp-content/plugins/wp-gdpr-compliance/assets/css/front.min.css?ver=1592813009' type='text/css' media='all' />
<style id='wpgdprc.css-inline-css' type='text/css'>

            div.wpgdprc .wpgdprc-switch .wpgdprc-switch-inner:before { content: 'Yes'; }
            div.wpgdprc .wpgdprc-switch .wpgdprc-switch-inner:after { content: 'No'; }
        
</style>
<script type='text/javascript' src='https://lab52.io/blog/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp' id='jquery-core-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/plugins/simple-social-icons/svgxuse.js?ver=1.1.21' id='svg-x-use-js'></script>
<link rel="https://api.w.org/" href="https://lab52.io/blog/wp-json/" /><link rel="alternate" type="application/json" href="https://lab52.io/blog/wp-json/wp/v2/posts/1347" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://lab52.io/blog/xmlrpc.php?rsd" />
<link rel="alternate" type="application/json+oembed" href="https://lab52.io/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Flab52.io%2Fblog%2Flooking-for-penquins-in-the-wild%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://lab52.io/blog/wp-json/oembed/1.0/embed?url=https%3A%2F%2Flab52.io%2Fblog%2Flooking-for-penquins-in-the-wild%2F&#038;format=xml" />
<style type="text/css"> .enews .screenread {
	height: 1px;
    left: -1000em;
    overflow: hidden;
    position: absolute;
    top: -1000em;
    width: 1px; } </style><link rel="pingback" href="https://lab52.io/blog/xmlrpc.php" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script defer src="https://www.googletagmanager.com/gtag/js?id=UA-138573737-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138573737-1');
</script>
<link rel="stylesheet" id="custom" href="/blog/wp-content/themes/genesis-sample-develop/custom.css" type="text/css" media="all">


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>

<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#edeff5",
      "text": "#838391"
    },
    "button": {
      "background": "#4b81e8"
    }
  },
  "theme": "classic",
  "content": {
    "message": "We use our own and third-party cookies to improve and analyze your use of our site. You can change the settings, reject them or get more information about our cookie policy",
    "href": "/cookie_policy"
  }
})});
</script><link rel="icon" href="https://lab52.io/blog/wp-content/uploads/2019/03/cropped-logo-Lab52-32x32.png" sizes="32x32" />
<link rel="icon" href="https://lab52.io/blog/wp-content/uploads/2019/03/cropped-logo-Lab52-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon" href="https://lab52.io/blog/wp-content/uploads/2019/03/cropped-logo-Lab52-180x180.png" />
<meta name="msapplication-TileImage" content="https://lab52.io/blog/wp-content/uploads/2019/03/cropped-logo-Lab52-270x270.png" />
</head>
<body class="post-template-default single single-post postid-1347 single-format-standard wp-custom-logo wp-embed-responsive header-full-width full-width-content genesis-breadcrumbs-hidden genesis-footer-widgets-visible first-block-core-paragraph" itemscope itemtype="https://schema.org/WebPage"><div class="site-container"><ul class="genesis-skip-link"><li><a href="#genesis-nav-primary" class="screen-reader-shortcut"> Skip to primary navigation</a></li><li><a href="#genesis-content" class="screen-reader-shortcut"> Skip to main content</a></li><li><a href="#genesis-footer-widgets" class="screen-reader-shortcut"> Skip to footer</a></li></ul><header class="site-header" itemscope itemtype="https://schema.org/WPHeader"><div class="wrap"><div class="title-area"><a href="https://lab52.io/blog/" class="custom-logo-link" rel="home"><img width="150" height="56" src="https://lab52.io/blog/wp-content/uploads/2019/03/lab52.png" class="custom-logo" alt="lab52" /></a><p class="site-title" itemprop="headline"><a href="https://lab52.io/blog/">lab52</a></p><p class="site-description" itemprop="description">The threat intelligence division of S2 Grupo</p></div><nav class="nav-primary" aria-label="Main" itemscope itemtype="https://schema.org/SiteNavigationElement" id="genesis-nav-primary"><div class="wrap"><ul id="menu-header-menu" class="menu genesis-nav-menu menu-primary js-superfish"><li id="menu-item-35" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-35"><a href="/" itemprop="url"><span itemprop="name">Home</span></a></li>
<li id="menu-item-36" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-36"><a href="/faq" itemprop="url"><span itemprop="name">Faq</span></a></li>
<li id="menu-item-167" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-167"><a href="/blog" itemprop="url"><span itemprop="name">Blog</span></a></li>
<li id="menu-item-38" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-38"><a href="/about" itemprop="url"><span itemprop="name">About</span></a></li>
<li id="menu-item-39" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-39"><a href="/contact" itemprop="url"><span itemprop="name">Contact</span></a></li>
</ul></div></nav></div></header><div class="site-inner"><div class="content-sidebar-wrap"><main class="content" id="genesis-content"><article class="post-1347 post type-post status-publish format-standard has-post-thumbnail category-uncategorised entry" aria-label="Looking for Penquins in the Wild" itemscope itemtype="https://schema.org/CreativeWork"><header class="entry-header"><h1 class="entry-title" itemprop="headline">Looking for Penquins in the Wild</h1>
<p class="entry-meta"><time class="entry-time" itemprop="datePublished" datetime="2022-02-28T10:28:38+01:00">February 28, 2022</time></p></header><div class="entry-content" itemprop="text">
<p>During 2020 <a href="https://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf" data-type="URL" data-id="https://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf">Leonardo analysts discovered and published</a> a very in depth analysis of a threat known as Penquin, attributed to the APT group Turla. 32-bit samples of this threat had been detected and analyzed by Kaspersky before, but the analysis in this most recent publication was focused on a new 64-bit sample.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="1024" height="197" src="https://lab52.io/blog/wp-content/uploads/2022/02/1-1024x197.png" alt="" class="wp-image-1348" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/1-1024x197.png 1024w, https://lab52.io/blog/wp-content/uploads/2022/02/1-300x58.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/1-768x147.png 768w, https://lab52.io/blog/wp-content/uploads/2022/02/1.png 1026w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure></div>



<p>It firstly caught our attention the fact that this threat does not have its own command and control server, but rather stands by waiting for a very specific packet generated by the attacker and from that packet it extracts its command and control server.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="567" height="441" src="https://lab52.io/blog/wp-content/uploads/2022/02/table.jpg" alt="" class="wp-image-1371" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/table.jpg 567w, https://lab52.io/blog/wp-content/uploads/2022/02/table-300x233.jpg 300w" sizes="(max-width: 567px) 100vw, 567px" /></figure></div>



<p>This results in the following logical scenario for an attacker to take control of the threat:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="645" height="327" src="https://lab52.io/blog/wp-content/uploads/2022/02/3-2.png" alt="" class="wp-image-1374" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/3-2.png 645w, https://lab52.io/blog/wp-content/uploads/2022/02/3-2-300x152.png 300w" sizes="(max-width: 645px) 100vw, 645px" /></figure></div>



<p>In the report published by Leonardo there is a lot of information related to the structure of such packet and the threat activation protocol, in fact, they published a version of an UDP scanner with a specific packet contacting an internal IP, in order to allow scanning internal networks for threats.</p>



<p>This threat, despite being a compiled and relatively complex binary, has the same capabilities that are usually found in webshells. Furthermore, the group itself could be said to use them in a similar way than other less advanced groups using webshells since it has been observed how in servers infected by this threat, command and controls from other Turla tools have been deployed in order to use them as infrastructure in recent campaigns.</p>



<p>This fact implies that the possibility of detecting new infections of this threat all over the Internet may allow identifying the infrastructure of current, and even future, Turla campaigns.</p>



<p>For this, we firstly need to be able to generate activation packets for public IPs controlled by us. Secondly, we are interested in being able to scan TCP ports as well, since there are cases of servers that have specific TCP ports exposed to the Internet and all UDP ports blocked.</p>



<p>Starting from public samples and the work already done and documented as a resource, we decided to implement a function that emulates the threat&#8217;s logic of checking the validity of that “Magic” packet and extracting the IP address of the C2 it is ordered to contact.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="1024" height="560" src="https://lab52.io/blog/wp-content/uploads/2022/02/4-1024x560.png" alt="" class="wp-image-1351" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/4-1024x560.png 1024w, https://lab52.io/blog/wp-content/uploads/2022/02/4-300x164.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/4-768x420.png 768w, https://lab52.io/blog/wp-content/uploads/2022/02/4.png 1325w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure></div>



<p>This allows us to quickly and automatically validate an inferred activation packet.</p>



<p>Rather than completely reverse the validation logic, in order to reverse the algorithm and try to generate specific packets we first tried brute-forcing the different elements within the UDP and TCP packets, and then leverage the function we had extracted from the threat to validate each combination for a public target IP controlled by us.</p>



<p>We know that the sample first extracts 32 bits from the packet, and compares them with the mask &#8220;0xbdbd0560&#8221;. In case it passes this first filter, it extracts another 32 bits and the source port, and passes this extracted information to the validation function we already have. The problem was that brute-forcing so many bytes would be too slow and not feasible.</p>



<p>Fortunately, there is a good part of the algorithm <a href="https://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf" data-type="URL" data-id="https://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf">already described</a>. Some of these elements are the fixed bits of the first mask and the bits that compose the IP address with which Penquin will contact (our controlled IP, in this case).</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="1000" height="583" src="https://lab52.io/blog/wp-content/uploads/2022/02/5-2.png" alt="" class="wp-image-1373" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/5-2.png 1000w, https://lab52.io/blog/wp-content/uploads/2022/02/5-2-300x175.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/5-2-768x448.png 768w" sizes="(max-width: 1000px) 100vw, 1000px" /></figure></div>



<p>The fixed bits of the first check take away most of the second block of 32 bits, and since we will want to generate the packets for an IP address controlled by us, we can subtract another 28 bits from the two blocks of 32, since these will have to be exactly those that build the IP of our server. In fact we could subtract 4 more bits from the source port that will also be dependent on the final IP, although in our case we consider it unnecessary. So instead of brute-forcing all possible combinations of two 32-bit blocks plus the port (16 bits more), we only have to brute-force 4 bits + 4 bits + 2 bits + 3 bits + the source port, which becomes trivial.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="766" height="415" src="https://lab52.io/blog/wp-content/uploads/2022/02/6.png" alt="" class="wp-image-1353" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/6.png 766w, https://lab52.io/blog/wp-content/uploads/2022/02/6-300x163.png 300w" sizes="(max-width: 766px) 100vw, 766px" /></figure></div>



<p>This would allow us to generate combinations for a destination IP and then check if the result is valid and it still generates the IP we expected it to generate.</p>



<p>However, there is still one last element to take into account:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="485" height="222" src="https://lab52.io/blog/wp-content/uploads/2022/02/7.png" alt="" class="wp-image-1354" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/7.png 485w, https://lab52.io/blog/wp-content/uploads/2022/02/7-300x137.png 300w" sizes="(max-width: 485px) 100vw, 485px" /></figure></div>



<p>The function that checks the validity of the packet within the threat (in the screenshot renamed to MagicStuff), returns as a parameter an ID extracted from the calculations it performs, which can contain a value between 0 and 3. Just before contacting the target server it compares this ID with the ID of the last contact with a C2, and it is initialized to 0 when the threat is executed for the first time. This avoids accepting the same packet twice, (and at the same time, the first packet cannot result in 0 after that calculation). Therefore, we need to generate two different packets if we want to make sure that in case we send it to an infected server, it will reply and avoid not receiving contact simply because we have sent the same ID as the attacker in the last contact.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="897" height="199" src="https://lab52.io/blog/wp-content/uploads/2022/02/8.png" alt="" class="wp-image-1355" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/8.png 897w, https://lab52.io/blog/wp-content/uploads/2022/02/8-300x67.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/8-768x170.png 768w" sizes="(max-width: 897px) 100vw, 897px" /></figure></div>



<p>Once two packets with different IDs and a controlled public IP have been generated, the last thing is to send them to a TCP or UDP port that is open on as many servers as possible and wait to receive responses on our server&#8217;s IP from the scanned IP addresses.</p>



<p>For this, in the case of UDP we already have the work done, but in the case of TCP the payload that checks the threat is not in the body of the TCP packet received, but in the headers, specifically in the Sequence Number and Aknowledgement Number, so we need to generate the packet in RAW to be able to control these elements:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="1024" height="278" src="https://lab52.io/blog/wp-content/uploads/2022/02/9-1024x278.png" alt="" class="wp-image-1356" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/9-1024x278.png 1024w, https://lab52.io/blog/wp-content/uploads/2022/02/9-300x81.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/9-768x208.png 768w, https://lab52.io/blog/wp-content/uploads/2022/02/9.png 1338w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure></div>



<p>Once all the elements are prepared and finished with a close resemblance to this one:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="524" height="363" src="https://lab52.io/blog/wp-content/uploads/2022/02/10.png" alt="" class="wp-image-1357" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/10.png 524w, https://lab52.io/blog/wp-content/uploads/2022/02/10-300x208.png 300w" sizes="(max-width: 524px) 100vw, 524px" /></figure></div>



<p>Now we finally can perform the scan 🙂</p>



<p>Different strategies have been used for the scanning. We have scanned ports 25 (TCP), 53 (UDP/ TCP), 80(TCP), 443(TCP), 8080(TCP) and we have tried to vary the &#8220;callback&#8221; port. To avoid unnecessary traffic, the sending and receiving packets are placed in different ip addresses. The IP address from where it is activated (source of our crafted packets) and the &#8220;supposed&#8221; C2 (server expected to be contacted) are in different servers. In the case of receiving packets in the expected address, a double check is made sending only to that IP, in order to verify that we are still receiving a response from Penquin.</p>



<p>After a first scan in June 2020 we registered 86 ip addresses hosting Penquin.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="1024" height="331" src="https://lab52.io/blog/wp-content/uploads/2022/02/11-1024x331.png" alt="" class="wp-image-1358" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/11-1024x331.png 1024w, https://lab52.io/blog/wp-content/uploads/2022/02/11-300x97.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/11-768x248.png 768w, https://lab52.io/blog/wp-content/uploads/2022/02/11.png 1301w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure></div>



<p>First of all, we were struck by the distribution of these infections, as they were all located in Europe, Russia and the United States.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="1024" height="295" src="https://lab52.io/blog/wp-content/uploads/2022/02/12-1024x295.png" alt="" class="wp-image-1359" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/12-1024x295.png 1024w, https://lab52.io/blog/wp-content/uploads/2022/02/12-300x86.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/12-768x221.png 768w, https://lab52.io/blog/wp-content/uploads/2022/02/12.png 1368w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure></div>



<p>The IP&#8217;s found correspond in most of the cases with VPS from a wide variety of providers.</p>



<p>On the other hand, Shodan offers us information suggesting that many of the IPs, as expected, have multitude of vulnerabilities.</p>



<p>In the image above we can see the vulnerabilities in RED color and the IPs in ORANGE color.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="831" height="638" src="https://lab52.io/blog/wp-content/uploads/2022/02/13.png" alt="" class="wp-image-1360" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/13.png 831w, https://lab52.io/blog/wp-content/uploads/2022/02/13-300x230.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/13-768x590.png 768w" sizes="(max-width: 831px) 100vw, 831px" /></figure></div>



<p>In total, vulnerabilities have been identified in 65% (+ or -) of the detected IPs.</p>



<p>Among the detections observed, these two IP addresses stand out:</p>



<ul><li>85.25.95[.]16</li><li>162.223.94[.]14</li></ul>



<p>At &#8220;first sight&#8221;, it can be observed how in VT this address is related to a binary that some antivirus vendors along with Intezer catalog as Turla.</p>



<p></p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="652" height="450" src="https://lab52.io/blog/wp-content/uploads/2022/02/14-1.png" alt="" class="wp-image-1377" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/14-1.png 652w, https://lab52.io/blog/wp-content/uploads/2022/02/14-1-300x207.png 300w" sizes="(max-width: 652px) 100vw, 652px" /></figure></div>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" width="979" height="200" src="https://lab52.io/blog/wp-content/uploads/2022/02/15.png" alt="" class="wp-image-1362" srcset="https://lab52.io/blog/wp-content/uploads/2022/02/15.png 979w, https://lab52.io/blog/wp-content/uploads/2022/02/15-300x61.png 300w, https://lab52.io/blog/wp-content/uploads/2022/02/15-768x157.png 768w" sizes="(max-width: 979px) 100vw, 979px" /></figure></div>



<p>Researching for more details about this sample, we find that it is mentioned in an <a href="https://cn.ahnlab.com/global/upload/download/asecreport/ahnlab_zh_202006%20vol.91.pdf">AnhLab Report about a Turla</a> campaign against the Korean Defense sector, which, along with this paragraph from Cisto Talos from July 2021 &#8220;One public reason why we attributed this backdoor to Turla is the fact that they used the same infrastructure as they used for other attacks that have been clearly attributed to their Penguin Turla Infrastructure.&#8221; Related to their analysis of <a href="https://blog.talosintelligence.com/2021/09/tinyturla.html">Tinyturla</a>, reinforces the hypothesis that they use Penquin as a tool to control machines that are then used as command and control servers or intermediate node servers for their operations.</p>



<p>References:</p>



<p>[1] <a href="https://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf">https://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf</a></p>



<p>[2] <a href="https://cn.ahnlab.com/global/upload/download/asecreport/ahnlab_zh_202006%20vol.91.pdf">https://cn.ahnlab.com/global/upload/download/asecreport/ahnlab_zh_202006%20vol.91.pdf</a></p>



<p>[3] <a href="https://blog.talosintelligence.com/2021/09/tinyturla.html">https://blog.talosintelligence.com/2021/09/tinyturla.html</a></p>



<p>IOCs</p>



<figure class="wp-block-table"><table><tbody><tr><td>1d5e4466a6c5723cd30caf8b1c3d33d1a3d4c94c25e2ebe186c02b8b41daf905</td><td>SHA256</td></tr><tr><td>2dabb2c5c04da560a6b56dbaa565d1eab8189d1fa4a85557a22157877065ea08</td><td>SHA256</td></tr><tr><td>3e138e4e34c6eed3506efc7c805fce19af13bd62aeb35544f81f111e83b5d0d4</td><td>SHA256</td></tr><tr><td>5a204263cac112318cd162f1c372437abf7f2092902b05e943e8784869629dd8</td><td>SHA256</td></tr><tr><td>67d9556c695ef6c51abf6fbab17acb3466e3149cf4d20cb64d6d34dc969b6502</td><td>SHA256</td></tr><tr><td>8856a68d95e4e79301779770a83e3fad8f122b849a9e9e31cfe06bf3418fa667</td><td>SHA256</td></tr><tr><td>8ccc081d4940c5d8aa6b782c16ed82528c0885bbb08210a8d0a8c519c54215bc</td><td>SHA256</td></tr><tr><td>d49690ccb82ff9d42d3ee9d7da693fd7d302734562de088e9298413d56b86ed0</td><td>SHA256</td></tr><tr><td>d9f2467ff11efae921ec83e074e4f8d2eac7881d76bff60a872a801bd45ce3d5</td><td>SHA256</td></tr><tr><td>85.25.95.16</td><td>Infected Server</td></tr><tr><td>162.223.94.14</td><td>Infected Server</td></tr></tbody></table></figure>



<p>Customers with Lab52’s APT intelligence private feed service already have more tools and means of detection for this campaign.<br>In case of having threat hunting service or being client of S2Grupo CERT, this intelligence has already been applied.</p>



<p>If you need more information about Lab52’s private APT intelligence feed service, you can contact us through the<a href="https://lab52.io/contact"> following link</a></p>
<!--<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
			xmlns:dc="http://purl.org/dc/elements/1.1/"
			xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
		<rdf:Description rdf:about="https://lab52.io/blog/looking-for-penquins-in-the-wild/"
    dc:identifier="https://lab52.io/blog/looking-for-penquins-in-the-wild/"
    dc:title="Looking for Penquins in the Wild"
    trackback:ping="https://lab52.io/blog/looking-for-penquins-in-the-wild/trackback/" />
</rdf:RDF>-->
</div><footer class="entry-footer"><p class="entry-meta"> <span class="entry-author" itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="https://lab52.io/blog/author/jagaimokawaii/" class="entry-author-link" rel="author" itemprop="url"><span class="entry-author-name" itemprop="name">JagaimoKawaii</span></a></span></p></footer></article><h2 class="screen-reader-text">Reader Interactions</h2>	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/blog/looking-for-penquins-in-the-wild/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://lab52.io/blog/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" required='required' /></p>
<div class="anr_captcha_field"><div id="anr_captcha_field_1" class="anr_captcha_field_div"></div></div><p class="wpgdprc-checkbox"><input type="checkbox" name="wpgdprc" id="wpgdprc" value="1" /><label for="wpgdprc">I hereby declare to have read and accepted the <a href="/legal_note">legal notice</a> and the <a href="/privacy_policy">privacy policy</a>. <abbr class="wpgdprc-required" title="You need to accept this checkbox.">*</abbr></label></p><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='1347' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p></form>	</div><!-- #respond -->
	<div class="related"><h3 class="related-title">Related</h3><div class="related-posts"><div class="related-post"><a href="https://lab52.io/blog/cyber-threat-intelligence-report-trends-q4-2022/" rel="bookmark" title="Permanent Link to Cyber Threat Intelligence Report – Trends Q4 2022"><img width="400" height="222" src="https://lab52.io/blog/wp-content/uploads/2023/02/Cabecera-ingles-740x370-1-400x222.png" class="related-post-image" alt="" loading="lazy" /></a><div class="related-post-info"><a class="related-post-title" href="https://lab52.io/blog/cyber-threat-intelligence-report-trends-q4-2022/" rel="bookmark" title="Permanent Link to Cyber Threat Intelligence Report – Trends Q4 2022">Cyber Threat Intelligence Report – Trends Q4 2022</a><div class="related-post-date"><time class="entry-time" itemprop="datePublished" datetime="2023-02-06T12:46:25+01:00">February 06, 2023</time></div><div class="related-post-tags"><span class="entry-tags">Tags: <a href="https://lab52.io/blog/tag/cybersecurity/" rel="tag">Cybersecurity</a>, <a href="https://lab52.io/blog/tag/intelligence/" rel="tag">Intelligence</a>, <a href="https://lab52.io/blog/tag/q4/" rel="tag">Q4</a>, <a href="https://lab52.io/blog/tag/trends/" rel="tag">Trends</a>, <a href="https://lab52.io/blog/tag/vulnerabilities/" rel="tag">vulnerabilities</a></span></div><div class="related-post-categories"></div></div></div><div class="related-post"><a href="https://lab52.io/blog/analyzing-the-encryption-method-of-emerging-ransomware-families/" rel="bookmark" title="Permanent Link to Analyzing the encryption method of emerging ransomware families"><img width="400" height="222" src="https://lab52.io/blog/wp-content/uploads/2022/11/ransom_image-400x222.png" class="related-post-image" alt="" loading="lazy" /></a><div class="related-post-info"><a class="related-post-title" href="https://lab52.io/blog/analyzing-the-encryption-method-of-emerging-ransomware-families/" rel="bookmark" title="Permanent Link to Analyzing the encryption method of emerging ransomware families">Analyzing the encryption method of emerging ransomware families</a><div class="related-post-date"><time class="entry-time" itemprop="datePublished" datetime="2022-11-29T11:02:14+01:00">November 29, 2022</time></div><div class="related-post-tags"><span class="entry-tags">Tags: <a href="https://lab52.io/blog/tag/axlocker/" rel="tag">AXLocker</a>, <a href="https://lab52.io/blog/tag/decryption/" rel="tag">Decryption</a>, <a href="https://lab52.io/blog/tag/ransomware/" rel="tag">ransomware</a></span></div><div class="related-post-categories"></div></div></div><div class="related-post"><a href="https://lab52.io/blog/nato-summit-2022-the-perfect-pretext-to-launch-a-cybercampaign/" rel="bookmark" title="Permanent Link to NATO Summit 2022: The perfect pretext to launch a cybercampaign"><img width="400" height="222" src="https://lab52.io/blog/wp-content/uploads/2022/07/Flag-North-Atlantic-Treaty-Organization-400x222.jpg" class="related-post-image" alt="" loading="lazy" /></a><div class="related-post-info"><a class="related-post-title" href="https://lab52.io/blog/nato-summit-2022-the-perfect-pretext-to-launch-a-cybercampaign/" rel="bookmark" title="Permanent Link to NATO Summit 2022: The perfect pretext to launch a cybercampaign">NATO Summit 2022: The perfect pretext to launch a cybercampaign</a><div class="related-post-date"><time class="entry-time" itemprop="datePublished" datetime="2022-07-06T12:00:00+02:00">July 06, 2022</time></div><div class="related-post-tags"></div><div class="related-post-categories"></div></div></div></div></div></main></div></div><div class="footer-widgets" id="genesis-footer-widgets"><h2 class="genesis-sidebar-title screen-reader-text">Footer</h2><div class="wrap"><div class="widget-area footer-widgets-1 footer-widget-area"><section id="search-4" class="widget widget_search"><div class="widget-wrap"><form class="search-form" method="get" action="https://lab52.io/blog/" role="search" itemprop="potentialAction" itemscope itemtype="https://schema.org/SearchAction"><label class="search-form-label screen-reader-text" for="searchform-1">Search this website</label><input class="search-form-input" type="search" name="s" id="searchform-1" placeholder="Search this website" itemprop="query-input"><input class="search-form-submit" type="submit" value="Search"><meta content="https://lab52.io/blog/?s={s}" itemprop="target"></form></div></section>
</div></div></div><footer class="site-footer" itemscope itemtype="https://schema.org/WPFooter"><div class="wrap"><p> <footer id="footer" class="full-width">                 <span class="small-text-footer italic">Copyright &amp;copy Lab52 2019 by <a href="https://s2grupo.es/en/home/" target="_blank">S2 Grupo</a> | <a href="/legal_note" target="_blank">Legal notice</a> | <a href="/cookie_policy" target="_blank">Cookie policy</a> | <a href="/privacy_policy" target="_blank">Privacy policy</a></span>             </footer></p></div></footer></div>			<script type="text/javascript">
				var anr_onloadCallback = function() {
					for ( var i = 0; i < document.forms.length; i++ ) {
						var form = document.forms[i];
						var captcha_div = form.querySelector( '.anr_captcha_field_div' );

						if ( null === captcha_div )
							continue;
						captcha_div.innerHTML = '';
						( function( form ) {
							var anr_captcha = grecaptcha.render( captcha_div,{
								'sitekey' : '6Lf4ZJwUAAAAAN67aD_PPXidoEzI-aIrP47hK41b',
								'size'  : 'normal',
								'theme' : 'light'
							});
							if ( typeof jQuery !== 'undefined' ) {
								jQuery( document.body ).on( 'checkout_error', function(){
									grecaptcha.reset(anr_captcha);
								});
							}
							if ( typeof wpcf7 !== 'undefined' ) {
								document.addEventListener( 'wpcf7submit', function() {
									grecaptcha.reset(anr_captcha);
								}, false );
							}
						})(form);
					}
				};
			</script>
						<script src="https://www.google.com/recaptcha/api.js?onload=anr_onloadCallback&#038;render=explicit"
				async defer>
			</script>
				<script type="text/javascript">
		function atomicBlocksShare( url, title, w, h ){
			var left = ( window.innerWidth / 2 )-( w / 2 );
			var top  = ( window.innerHeight / 2 )-( h / 2 );
			return window.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=600, height=600, top='+top+', left='+left);
		}
	</script>
	<script type="text/javascript" src="/blog/wp-content/themes/genesis-sample-develop/custom.js"></script> 
<style type="text/css" media="screen"></style><script type='text/javascript' src='https://lab52.io/blog/wp-content/plugins/atomic-blocks/dist/assets/js/dismiss.js?ver=1598525594' id='atomic-blocks-dismiss-js-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-includes/js/comment-reply.min.js?ver=5.5.11' id='comment-reply-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-includes/js/hoverIntent.min.js?ver=1.8.1' id='hoverIntent-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis/lib/js/menu/superfish.min.js?ver=1.7.10' id='superfish-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis/lib/js/menu/superfish.args.min.js?ver=3.3.3' id='superfish-args-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis/lib/js/skip-links.min.js?ver=3.3.3' id='skip-links-js'></script>
<script type='text/javascript' id='genesis-sample-responsive-menu-js-extra'>
/* <![CDATA[ */
var genesis_responsive_menu = {"mainMenu":"Menu","menuIconClass":"dashicons-before dashicons-menu","subMenu":"Submenu","subMenuIconClass":"dashicons-before dashicons-arrow-down-alt2","menuClasses":{"combine":[".nav-primary"],"others":[]}};
/* ]]> */
</script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis-sample-develop/js/responsive-menus.min.js?ver=2.9.2-dev' id='genesis-sample-responsive-menu-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/themes/genesis-sample-develop/js/genesis-sample.js?ver=2.9.2-dev' id='genesis-sample-js'></script>
<script type='text/javascript' id='wpgdprc.js-js-extra'>
/* <![CDATA[ */
var wpgdprcData = {"ajaxURL":"https:\/\/lab52.io\/blog\/wp-admin\/admin-ajax.php","ajaxSecurity":"868b2c516d","isMultisite":"","path":"\/","blogId":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://lab52.io/blog/wp-content/plugins/wp-gdpr-compliance/assets/js/front.min.js?ver=1592813009' id='wpgdprc.js-js'></script>
<script type='text/javascript' src='https://lab52.io/blog/wp-includes/js/wp-embed.min.js?ver=5.5.11' id='wp-embed-js'></script>
</body></html>

<!-- Dynamic page generated in 0.907 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2023-03-17 16:38:06 -->

<!-- super cache -->